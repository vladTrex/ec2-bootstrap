name: Deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (e.g. latest, sha-xxxx)"
        required: true
        default: latest

env:
  IMAGE: ghcr.io/${{ github.repository }} # owner/repo
  CONTAINER_NAME: ec2-bootstrap
  PORT: "3030"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail

            IMAGE_LOWER=$(echo "${{ env.IMAGE }}" | tr '[:upper:]' '[:lower:]')
            IMAGE="${IMAGE_LOWER}:${{ inputs.tag }}"
            NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ env.PORT }}"

            sudo systemctl start docker || true

            docker pull "$IMAGE"
            docker rm -f "$NAME" || true

            docker run -d \
              --name "$NAME" \
              --restart unless-stopped \
              -p "${PORT}:${PORT}" \
              "$IMAGE"

            curl -fsS "http://localhost:${PORT}" >/dev/null
            echo "âœ… Deployed: $IMAGE"
