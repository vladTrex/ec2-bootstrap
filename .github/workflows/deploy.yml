name: Deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (e.g. latest, sha-xxxx)"
        required: true
        default: latest

env:
  IMAGE: ghcr.io/${{ github.repository }} # owner/repo
  CONTAINER_NAME: ec2-bootstrap
  PORT: "3030"

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -euo pipefail

            IMAGE_LOWER=$(echo "${{ env.IMAGE }}" | tr '[:upper:]' '[:lower:]')
            IMAGE="${IMAGE_LOWER}:${{ inputs.tag }}"
            NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ env.PORT }}"

            sudo systemctl start docker || true

            # Install CloudWatch agent if not installed
            if ! command -v amazon-cloudwatch-agent &> /dev/null; then
              echo "Installing CloudWatch agent..."
              wget https://s3.amazonaws.com/amazoncloudwatch-agent/amazon_linux/amd64/latest/amazon-cloudwatch-agent.rpm
              sudo rpm -U ./amazon-cloudwatch-agent.rpm
              rm -f amazon-cloudwatch-agent.rpm
            fi

            # Configure CloudWatch agent for Docker logs
            INSTANCE_ID=$(ec2-metadata --instance-id | cut -d " " -f 2)
            sudo mkdir -p /opt/aws/amazon-cloudwatch-agent/etc
            sudo tee /opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json > /dev/null <<EOF
            {
              "logs": {
                "logs_collected": {
                  "files": {
                    "collect_list": [
                      {
                        "file_path": "/var/lib/docker/containers/*/*-json.log",
                        "log_group_name": "/ec2/ec2-bootstrap/docker",
                        "log_stream_name": "${INSTANCE_ID}-docker",
                        "timezone": "UTC"
                      }
                    ]
                  }
                }
              }
            }
            EOF

            # Start CloudWatch agent
            sudo systemctl enable amazon-cloudwatch-agent
            sudo systemctl restart amazon-cloudwatch-agent || sudo /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl \
              -a fetch-config \
              -m ec2 \
              -c file:/opt/aws/amazon-cloudwatch-agent/etc/amazon-cloudwatch-agent.json \
              -s

            docker pull "$IMAGE"
            docker rm -f "$NAME" || true

            docker run -d \
              --name "$NAME" \
              --restart unless-stopped \
              -p "${PORT}:${PORT}" \
              "$IMAGE"

            docker ps --filter "name=$NAME"
            echo "✅ Deployed: $IMAGE"
            echo "✅ CloudWatch agent configured"