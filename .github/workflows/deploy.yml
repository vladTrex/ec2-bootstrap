name: Deploy

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag to deploy (e.g. latest, staging-<sha>, prod-<sha>)"
        required: true
        default: latest

env:
  IMAGE: ghcr.io/${{ github.repository }}
  CONTAINER_NAME: ec2-bootstrap
  PORT: "3030"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 60s
          script: |
            set -euo pipefail

            IMAGE_LOWER=$(echo "${{ env.IMAGE }}" | tr '[:upper:]' '[:lower:]')
            IMAGE="${IMAGE_LOWER}:${{ inputs.tag }}"
            NAME="${{ env.CONTAINER_NAME }}"
            PORT="${{ env.PORT }}"

            echo "== Preflight =="
            echo "Image: $IMAGE"
            echo "Container: $NAME"
            echo "Port: $PORT"

            sudo systemctl start docker || true

            echo "== Pull image =="
            docker pull "$IMAGE"

            echo "== Stop old container =="
            docker stop "$NAME" 2>/dev/null || true
            docker rm -f "$NAME" 2>/dev/null || true

            echo "== Run new container =="
            docker run -d \
              --name "$NAME" \
              --restart unless-stopped \
              -p "${PORT}:${PORT}" \
              "$IMAGE"

            echo "== Verify =="
            docker ps --filter "name=$NAME"

            curl -fsS "http://localhost:${PORT}/health" >/dev/null \
              && echo "✅ /health OK" \
              || echo "⚠️ /health not ready yet"

            echo "✅ Deployed: $IMAGE"